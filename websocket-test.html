<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <div>
        <h2>WebSocket Chat Test</h2>
        <div>
            <label>JWT Token:</label>
            <input type="text" id="token" style="width: 500px;"
                   value="eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiI5IiwiaWF0IjoxNzU4MDUzNTE4LCJleHAiOjE3NTgwNTcxMTh9.safWMIJHKSojoLoqivg9Q80KHjo9iG3sM0gP0ZxkYgQ">
        </div>
        <div>
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
        </div>
        <div>
            <label>Conversation ID:</label>
            <input type="number" id="conversationId" value="1">
        </div>
        <div>
            <label>Message:</label>
            <input type="text" id="messageInput" placeholder="Type your message">
            <button onclick="sendMessage()">Send via WebSocket</button>
        </div>
        <div>
            <h3>Messages:</h3>
            <div id="messages" style="border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px;"></div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let connected = false;

        function connect() {
            const token = document.getElementById('token').value;
            addLog('Attempting to connect with token: ' + (token ? 'present' : 'missing'));

            const socket = new SockJS('http://localhost:8080/ws');
            stompClient = Stomp.over(socket);

            // Enable debug
            stompClient.debug = function(str) {
                console.log('[STOMP] ' + str);
                addLog('[STOMP] ' + str);
            };

            stompClient.connect(
                { 'Authorization': 'Bearer ' + token },
                function(frame) {
                    console.log('Connected: ' + frame);
                    connected = true;

                    // Subscribe to conversation messages
                    const conversationId = document.getElementById('conversationId').value;
                    stompClient.subscribe('/topic/conversation/' + conversationId, function(message) {
                        const messageData = JSON.parse(message.body);
                        showMessage(messageData);
                    });

                    addLog('Connected to WebSocket successfully!');
                },
                function(error) {
                    console.log('Connection error: ' + error);
                    addLog('Connection error: ' + error);
                    connected = false;
                }
            );
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
                connected = false;
                addLog('Disconnected from WebSocket');
            }
        }

        function sendMessage() {
            if (!connected) {
                alert('Please connect first');
                return;
            }

            const conversationId = document.getElementById('conversationId').value;
            const messageText = document.getElementById('messageInput').value;

            if (messageText.trim() === '') {
                alert('Please enter a message');
                return;
            }

            stompClient.send('/app/conversation/' + conversationId + '/send', {},
                JSON.stringify({ 'body': messageText }));

            document.getElementById('messageInput').value = '';
        }

        function showMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.style.marginBottom = '10px';
            messageElement.style.padding = '5px';
            messageElement.style.backgroundColor = '#f0f0f0';
            messageElement.innerHTML =
                '<strong>' + message.sender.username + '</strong> (' + message.createdAt + ')<br>' +
                message.body;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addLog(message) {
            const messagesDiv = document.getElementById('messages');
            const logElement = document.createElement('div');
            logElement.style.marginBottom = '5px';
            logElement.style.color = '#666';
            logElement.style.fontStyle = 'italic';
            logElement.textContent = '[LOG] ' + message;
            messagesDiv.appendChild(logElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>